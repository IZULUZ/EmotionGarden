<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆìŒë°­ ê´€ë¦¬ì - ì„ ìƒë‹˜ìš©</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="admin-page">
    <header class="admin-header">
        <h2>ìš°ë¦¬ ë°˜ ë§ˆìŒë°­ ì‹¤ì‹œê°„ í˜„í™©</h2>
        <div class="admin-stats">ì°¸ì—¬ ì¸ì›: <span id="active-count">0</span>ëª…</div>
    </header>

    <div id="student-grid" class="admin-grid">
        </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDw773x1yot2uncAMl_gTQ6z6Njhgh1Od8",
            authDomain: "secret-quest-class.firebaseapp.com",
            databaseURL: "https://secret-quest-class-default-rtdb.firebaseio.com",
            projectId: "secret-quest-class",
            storageBucket: "secret-quest-class.firebasestorage.app",
            messagingSenderId: "397245266210",
            appId: "1:397245266210:web:fde35d6a4dfd6ca7070d7b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // í•™ìƒ ë°ì´í„° ì‹¤ì‹œê°„ ê°ì‹œ
        db.ref('students').on('value', (snapshot) => {
            const grid = document.getElementById('student-grid');
            grid.innerHTML = '';
            let count = 0;

            snapshot.forEach(child => {
                const s = child.val();
                if(s.lastLogin) count++;
                
                const card = document.createElement('div');
                card.className = `student-card ${s.isRecording ? 'pulse' : ''}`;
                card.innerHTML = `
                    <div class="card-header">
                        <span class="st-num">${s.number || ''}</span>
                        <span class="st-name">${s.name}</span>
                        <span class="status-dot ${s.online ? 'on' : ''}"></span>
                    </div>
                    <div class="st-emotion">${s.emoji || 'ğŸŒ±'}</div>
                    <div class="st-tags">${s.tags || '#ì•„ì§_ê¸°ë¡ì „'}</div>
                    <div class="quest-status">
                        <h5>ì§„í–‰ ì¤‘ì¸ í€˜ìŠ¤íŠ¸</h5>
                        <ul id="q-list-${child.key}"></ul>
                    </div>
                `;
                grid.appendChild(card);

                // í•´ë‹¹ í•™ìƒì˜ í€˜ìŠ¤íŠ¸ ì¤‘ 'ê²€í†  ëŒ€ê¸°(pending)' ìƒíƒœì¸ ê²ƒ í‘œì‹œ
                if(s.quests) {
                    const qList = document.getElementById(`q-list-${child.key}`);
                    Object.keys(s.quests).forEach(qKey => {
                        const q = s.quests[qKey];
                        const li = document.createElement('li');
                        li.innerHTML = `
                            ${q.title} 
                            ${q.status === 'pending' ? 
                            `<button class="btn-approve" onclick="approveQuest('${child.key}', '${qKey}')">ìŠ¹ì¸</button>` : 
                            `<span class="done">ì™„ë£Œë¨</span>`}
                        `;
                        qList.appendChild(li);
                    });
                }
            });
            document.getElementById('active-count').innerText = count;
        });

        function approveQuest(stId, qKey) {
            // 1. í¬ì¸íŠ¸ ì§€ê¸‰ 2. í€˜ìŠ¤íŠ¸ ìƒíƒœ ì™„ë£Œë¡œ ë³€ê²½
            db.ref(`students/${stId}/quests/${qKey}`).update({ status: 'completed' });
            db.ref(`students/${stId}`).transaction(current => {
                if(current) {
                    current.points = (current.points || 0) + 10;
                }
                return current;
            });
            alert('í€˜ìŠ¤íŠ¸ ìŠ¹ì¸ ë° í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
    </script>
</body>
</html>
